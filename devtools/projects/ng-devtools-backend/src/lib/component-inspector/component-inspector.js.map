{"version":3,"file":"component-inspector.js","sourceRoot":"","sources":["component-inspector.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google LLC All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.dev/license\n */\n\nimport {ElementPosition, HydrationStatus} from '../../../../protocol';\n\nimport {findNodeInForest} from '../component-tree/component-tree';\nimport {\n  findComponentAndHost,\n  highlightHydrationElement,\n  highlightSelectedElement,\n  removeHydrationHighlights,\n  unHighlight,\n} from '../highlighter';\nimport {initializeOrGetDirectiveForestHooks} from '../hooks';\nimport {ComponentTreeNode} from '../interfaces';\n\ninterface Type<T> extends Function {\n  new (...args: any[]): T;\n}\nexport interface ComponentInspectorOptions {\n  onComponentEnter: (id: number) => void;\n  onComponentSelect: (id: number) => void;\n  onComponentLeave: () => void;\n}\n\nexport class ComponentInspector {\n  private _selectedComponent!: {component: Type<unknown>; host: HTMLElement | null};\n  private readonly _onComponentEnter;\n  private readonly _onComponentSelect;\n  private readonly _onComponentLeave;\n\n  constructor(\n    componentOptions: ComponentInspectorOptions = {\n      onComponentEnter: () => {},\n      onComponentLeave: () => {},\n      onComponentSelect: () => {},\n    },\n  ) {\n    this.bindMethods();\n    this._onComponentEnter = componentOptions.onComponentEnter;\n    this._onComponentSelect = componentOptions.onComponentSelect;\n    this._onComponentLeave = componentOptions.onComponentLeave;\n  }\n\n  startInspecting(): void {\n    window.addEventListener('mouseover', this.elementMouseOver, true);\n    window.addEventListener('click', this.elementClick, true);\n    window.addEventListener('mouseout', this.cancelEvent, true);\n  }\n\n  stopInspecting(): void {\n    window.removeEventListener('mouseover', this.elementMouseOver, true);\n    window.removeEventListener('click', this.elementClick, true);\n    window.removeEventListener('mouseout', this.cancelEvent, true);\n  }\n\n  elementClick(e: MouseEvent): void {\n    e.stopImmediatePropagation();\n    e.preventDefault();\n\n    if (this._selectedComponent.component && this._selectedComponent.host) {\n      this._onComponentSelect(\n        initializeOrGetDirectiveForestHooks().getDirectiveId(this._selectedComponent.component)!,\n      );\n    }\n  }\n\n  elementMouseOver(e: MouseEvent): void {\n    this.cancelEvent(e);\n\n    const el = e.target as HTMLElement;\n    if (el) {\n      this._selectedComponent = findComponentAndHost(el);\n    }\n\n    unHighlight();\n    if (this._selectedComponent.component && this._selectedComponent.host) {\n      highlightSelectedElement(this._selectedComponent.host);\n      this._onComponentEnter(\n        initializeOrGetDirectiveForestHooks().getDirectiveId(this._selectedComponent.component)!,\n      );\n    }\n  }\n\n  cancelEvent(e: MouseEvent): void {\n    e.stopImmediatePropagation();\n    e.preventDefault();\n    this._onComponentLeave();\n  }\n\n  bindMethods(): void {\n    this.startInspecting = this.startInspecting.bind(this);\n    this.stopInspecting = this.stopInspecting.bind(this);\n    this.elementMouseOver = this.elementMouseOver.bind(this);\n    this.elementClick = this.elementClick.bind(this);\n    this.cancelEvent = this.cancelEvent.bind(this);\n  }\n\n  highlightByPosition(position: ElementPosition): void {\n    const forest: ComponentTreeNode[] = initializeOrGetDirectiveForestHooks().getDirectiveForest();\n    const elementToHighlight: HTMLElement | null = findNodeInForest(position, forest);\n    if (elementToHighlight) {\n      highlightSelectedElement(elementToHighlight);\n    }\n  }\n\n  highlightHydrationNodes(): void {\n    const forest: ComponentTreeNode[] = initializeOrGetDirectiveForestHooks().getDirectiveForest();\n\n    // drop the root nodes, we don't want to highlight it\n    const forestWithoutRoots = forest.flatMap((rootNode) => rootNode.children);\n\n    const errorNodes = findErrorNodesForHydrationOverlay(forestWithoutRoots);\n\n    // We get the first level of hydrated nodes\n    // nested mismatched nodes nested in hydrated nodes aren't includes\n    const nodes = findNodesForHydrationOverlay(forestWithoutRoots);\n\n    // This ensures top level mismatched nodes are removed as we have a dedicated array\n    const otherNodes = nodes.filter(({status}) => status?.status !== 'mismatched');\n\n    for (const {node, status} of [...otherNodes, ...errorNodes]) {\n      highlightHydrationElement(node, status);\n    }\n  }\n\n  removeHydrationHighlights() {\n    removeHydrationHighlights();\n  }\n}\n\n/**\n * Returns the first level of hydrated nodes\n * Note: Mismatched nodes nested in hydrated nodes aren't included\n */\nfunction findNodesForHydrationOverlay(\n  forest: ComponentTreeNode[],\n): {node: Node; status: HydrationStatus}[] {\n  return forest.flatMap((node) => {\n    if (node?.hydration?.status) {\n      // We highlight first level\n      return {node: node.nativeElement!, status: node.hydration};\n    }\n    if (node.children.length) {\n      return findNodesForHydrationOverlay(node.children);\n    }\n    return [];\n  });\n}\n\nfunction findErrorNodesForHydrationOverlay(\n  forest: ComponentTreeNode[],\n): {node: Node; status: HydrationStatus}[] {\n  return forest.flatMap((node) => {\n    if (node?.hydration?.status === 'mismatched') {\n      // We highlight first level\n      return {node: node.nativeElement!, status: node.hydration};\n    }\n    if (node.children.length) {\n      return findNodesForHydrationOverlay(node.children);\n    }\n    return [];\n  });\n}\n"]}