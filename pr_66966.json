{
  "body": "# PR: perf(language-service): progressive project initialization\n\n## Description\n\nReplaces the blocking `project.refreshDiagnostics()` during project initialization with a progressive background approach. Instead of sending all diagnostic refresh events at once, open files are now processed in configurable chunks with event loop yields between them, keeping the IDE responsive during Angular project startup.\n\n## Problem\n\nWhen a project finishes loading (`ProjectLoadingFinishEvent`), the language server calls:\n\n```typescript\nthis.runGlobalAnalysisForNewlyLoadedProject(project);\nproject.refreshDiagnostics(); // triggers diagnostics for ALL open files at once\n```\n\nThe `project.refreshDiagnostics()` call sends a `ProjectsUpdatedInBackgroundEvent` which triggers diagnostic computation for all open files. While the existing `sendPendingDiagnostics` already yields between individual files, the initial event processing can still cause a burst of work that degrades IDE responsiveness during startup.\n\n## Solution\n\nReplaced `project.refreshDiagnostics()` with a new `initializeProjectProgressively()` method that:\n\n1. **Processes files in chunks** (default: 10 files per chunk)\n2. **Yields to the event loop** between chunks via `setImmediateP()`\n3. **Sends diagnostics immediately** per file — users see results appearing progressively\n4. **Cancels gracefully** if:\n   - The project is closed during initialization\n   - A new diagnostics request arrives (e.g., user starts typing)\n   - Another progressive init is started (e.g., project reloads)\n\n```\nBefore (blocking refresh):\n  Analysis → [refreshDiagnostics: ALL FILES EVENT] → sendPendingDiagnostics\n              (single burst of work scheduled)\n\nAfter (progressive):\n  Analysis → [chunk 1] → yield → [chunk 2] → yield → ... → Done\n              ↑                    ↑\n      (UI responsive, LSP requests served between chunks)\n```\n\n### Cancellation Integration\n\nProgressive initialization integrates with the existing diagnostics system:\n- When `triggerDiagnostics()` is called (file opened/changed), any ongoing progressive init is cancelled via `progressiveInitCancelled` flag\n- This prevents stale startup diagnostics from overwriting fresher results\n- The pattern mirrors the existing `diagnosticsTimeout` cancellation logic\n\n## Changes\n\n| File | Change |\n|------|--------|\n| `vscode-ng-language-service/server/src/session.ts` | Added `progressiveInitCancelled` field, `initializeProjectProgressively()` method, cancellation in `triggerDiagnostics()`, replaced `project.refreshDiagnostics()` in `enableLanguageServiceForProject()` |\n\n## Impact\n\n- **UI remains responsive** during project startup\n- **Diagnostics appear progressively** — first results visible within seconds\n- **No change to final state** — all open files get diagnostics, same as before\n- **Minimal code change** — single file, no API changes\n\n## Testing\n\n- All language service tests pass (modern + legacy): `//packages/language-service/...`\n- All LSP integration tests pass: `//vscode-ng-language-service/integration/lsp:test`\n- All server unit tests pass: `//vscode-ng-language-service/server/src/tests:test`\n- Tests implicitly validate responsiveness (would timeout if event loop blocked)\n\n## Breaking Changes\n\nNone. This is an internal optimization that doesn't change observable behavior.\n\n## Related\n\nComplements:\n- #66700 (Pull-Based Diagnostics)\n- #66964 (Lighter Analysis Trigger)\n- #66668 (Client-Side File Watching)\n\n---\n\n## AI Disclosure\n\nThis PR was developed using Claude Opus 4 AI assistant under human orchestration and review by @kbrilla.\n\n## Integration\n\nSee #66967 for integration with Pull-Based Diagnostics, which optimizes progressive init to use `workspace/diagnostic/refresh` instead of computing and pushing diagnostics when the client supports pull-based diagnostics.",
  "comments": [],
  "files": [
    {"additions": 87, "deletions": 3, "path": "vscode-ng-language-service/server/src/session.ts"}
  ],
  "title": "perf(language-service): progressive project initialization"
}
